<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <link rel="icon" href="<%= BASE_URL %>favicon.ico">
    <title><%= htmlWebpackPlugin.options.title %></title>
  </head>
  <body>
    <script src="https://cdn.jsdelivr.net/gh/phinajs/phina.js@v0.2.3/build/phina.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.3.0/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.11"></script>
    <noscript>
      <strong>We're sorry but <%= htmlWebpackPlugin.options.title %> doesn't work properly without JavaScript enabled. Please enable it to continue.</strong>
    </noscript>
    <div id="game">
      <div class="container">
        <header>
          <h1 class="headline">
            <a>HibiNeko-Career-Poker</a>
          </h1>
        </header>
          <canvas id = "mycanvas"></canvas>
          <div class="text-area">
          <div class="chat-area" ref="chatScroll">
            <div v-for="chatMessage in messages" v-bind:key="chatMessage.id">{{ chatMessage }}</div>
          </div>
          <div class="chat-container">
            <input type="text" class="chat-input" v-model='message' v-on:keydown.enter='postChat' />
            <button class="chat-button" v-on:click='postChat'>post</button>
          </div>
          <div class="info-area">
            <div>ID:{{ player.ID }}</div>
            <div>name:{{ player.name }}</div>
            <div>枚数:{{ player.cardRemain }}</div>
            <div>Turn:{{ player.turnFlag }}</div>
          </div>
        </div>
      </div>
    </div>
    <div id="app"></div>
    <!-- built files will be auto injected -->
  </body>
</html>

<script type='module'>
  import ClientNekoCareerPoker from './js/ClientNekoCareerPoker.js';
  let socket = io('192.168.33.77:4000');
  let app = new Vue({
  el: '#game',
  data: {
    message: 'Welcome to HibiNeko-Career-Poker!',
    messages: [],
    player: '',
    socket: ''
  },
  created() {
    this.socket = socket;
    this.socket.on('chat_from_server', (txt) => {
        console.log(txt);
        this.messages.push(txt);
      });
    this.socket.on('gameInfo', (_player) => {
      console.log(_player);
      this.player = _player;
    });
    this.socket.on('changeViewTurn', (_player) => {
      this.player = _player;
    });
  },
  updated() {
    this.scrollToEnd()
  },
  methods: {
    postChat: function() {
      this.socket.emit('chat_from_front', this.message, player.roomName);
    },
    scrollToEnd() {
          this.$nextTick(() => {
              const chatLog = this.$refs.chatScroll
              if (!chatLog) return
              chatLog.scrollTop = chatLog.scrollHeight
           });
        }
    }
});

//ファイル読み込み
//let ClientNekoCareerPoker = require('./ClientNekoCareerPoker.js');
//import { ClientNekoCareerPoker } from './ClientNekoCareerPoker.js';
//let nk = new ClientNekoCareerPoker(test);

// グローバルに展開
phina.globalize();
//アセット
var ASSETS = {
  // 画像
  image: {
    "S1":"https://chicodeza.com/wordpress/wp-content/uploads/torannpu-illust1.png",
    "S2":"https://chicodeza.com/wordpress/wp-content/uploads/torannpu-illust2.png",
    "S3":"https://chicodeza.com/wordpress/wp-content/uploads/torannpu-illust3.png",
    "S4":"https://chicodeza.com/wordpress/wp-content/uploads/torannpu-illust4.png",
    "S5":"https://chicodeza.com/wordpress/wp-content/uploads/torannpu-illust5.png",
    "S6":"https://chicodeza.com/wordpress/wp-content/uploads/torannpu-illust6.png",
    "S7":"https://chicodeza.com/wordpress/wp-content/uploads/torannpu-illust7.png",
    "S8":"https://chicodeza.com/wordpress/wp-content/uploads/torannpu-illust8.png",
    "S9":"https://chicodeza.com/wordpress/wp-content/uploads/torannpu-illust9.png",
    "S10":"https://chicodeza.com/wordpress/wp-content/uploads/torannpu-illust10.png",
    "S11":"https://chicodeza.com/wordpress/wp-content/uploads/torannpu-illust11.png",
    "S12":"https://chicodeza.com/wordpress/wp-content/uploads/torannpu-illust12.png",
    "S13":"https://chicodeza.com/wordpress/wp-content/uploads/torannpu-illust13.png",
    "C1":"https://chicodeza.com/wordpress/wp-content/uploads/torannpu-illust14.png",
    "C2":"https://chicodeza.com/wordpress/wp-content/uploads/torannpu-illust15.png",
    "C3":"https://chicodeza.com/wordpress/wp-content/uploads/torannpu-illust16.png",
    "C4":"https://chicodeza.com/wordpress/wp-content/uploads/torannpu-illust17.png",
    "C5":"https://chicodeza.com/wordpress/wp-content/uploads/torannpu-illust18.png",
    "C6":"https://chicodeza.com/wordpress/wp-content/uploads/torannpu-illust19.png",
    "C7":"https://chicodeza.com/wordpress/wp-content/uploads/torannpu-illust20.png",
    "C8":"https://chicodeza.com/wordpress/wp-content/uploads/torannpu-illust21.png",
    "C9":"https://chicodeza.com/wordpress/wp-content/uploads/torannpu-illust22.png",
    "C10":"https://chicodeza.com/wordpress/wp-content/uploads/torannpu-illust23.png",
    "C11":"https://chicodeza.com/wordpress/wp-content/uploads/torannpu-illust24.png",
    "C12":"https://chicodeza.com/wordpress/wp-content/uploads/torannpu-illust25.png",
    "C13":"https://chicodeza.com/wordpress/wp-content/uploads/torannpu-illust26.png",
    "D1":"https://chicodeza.com/wordpress/wp-content/uploads/torannpu-illust27.png",
    "D2":"https://chicodeza.com/wordpress/wp-content/uploads/torannpu-illust28.png",
    "D3":"https://chicodeza.com/wordpress/wp-content/uploads/torannpu-illust29.png",
    "D4":"https://chicodeza.com/wordpress/wp-content/uploads/torannpu-illust30.png",
    "D5":"https://chicodeza.com/wordpress/wp-content/uploads/torannpu-illust31.png",
    "D6":"https://chicodeza.com/wordpress/wp-content/uploads/torannpu-illust32.png",
    "D7":"https://chicodeza.com/wordpress/wp-content/uploads/torannpu-illust33.png",
    "D8":"https://chicodeza.com/wordpress/wp-content/uploads/torannpu-illust34.png",
    "D9":"https://chicodeza.com/wordpress/wp-content/uploads/torannpu-illust35.png",
    "D10":"https://chicodeza.com/wordpress/wp-content/uploads/torannpu-illust36.png",
    "D11":"https://chicodeza.com/wordpress/wp-content/uploads/torannpu-illust37.png",
    "D12":"https://chicodeza.com/wordpress/wp-content/uploads/torannpu-illust38.png",
    "D13":"https://chicodeza.com/wordpress/wp-content/uploads/torannpu-illust39.png",
    "H1":"https://chicodeza.com/wordpress/wp-content/uploads/torannpu-illust40.png",
    "H2":"https://chicodeza.com/wordpress/wp-content/uploads/torannpu-illust41.png",
    "H3":"https://chicodeza.com/wordpress/wp-content/uploads/torannpu-illust42.png",
    "H4":"https://chicodeza.com/wordpress/wp-content/uploads/torannpu-illust43.png",
    "H5":"https://chicodeza.com/wordpress/wp-content/uploads/torannpu-illust44.png",
    "H6":"https://chicodeza.com/wordpress/wp-content/uploads/torannpu-illust45.png",
    "H7":"https://chicodeza.com/wordpress/wp-content/uploads/torannpu-illust46.png",
    "H8":"https://chicodeza.com/wordpress/wp-content/uploads/torannpu-illust47.png",
    "H9":"https://chicodeza.com/wordpress/wp-content/uploads/torannpu-illust48.png",
    "H10":"https://chicodeza.com/wordpress/wp-content/uploads/torannpu-illust49.png",
    "H11":"https://chicodeza.com/wordpress/wp-content/uploads/torannpu-illust50.png",
    "H12":"https://chicodeza.com/wordpress/wp-content/uploads/torannpu-illust51.png",
    "H13":"https://chicodeza.com/wordpress/wp-content/uploads/torannpu-illust52.png",
    "J14":"https://chicodeza.com/wordpress/wp-content/uploads/torannpu-illust53.png",
  },
};
//グローバル
let player;
let players = new Array();
let labels =  new Array();
//let opponentLabels;//new Array();
let roomName;
let trumps;
let trumpSprites = new Array();
let postTrumps = new Array();
let stageTrumps = new Array();
let stageTrumpSprites = new Array();
let fontSize = 50;
document.body.style.cursor = "pointer";

phina.define("MainScene", {
  // 継承
  superClass: 'DisplayScene',
  // 初期化
  init: function(option) {
    // 親クラス初期化
    this.superInit(option);
    // 背景色
    this.backgroundColor = 'black';
    
    this.opponentLabels = new Array();
    this.opponentLabel01 = '';
    this.opponentLabel02 = '';
    this.opponentLabel03 = '';

    this.pass =  Shape({
      width: 200,
      height: 50
    });
    this.pass.backgroundColor = 'green';
    this.pass.addChildTo(this);
    this.pass.setPosition(this.gridX.center(-5), this.gridY.center(6.8));
    this.pass.setInteractive(false);
    this.pass.onpointstart = function() {
          socket.emit('changeTurn', player.ID, roomName);
    };
    this.pass.on('pointover', () => {
      this.pass.alpha = 0.5;
    });
    this.pass.on('pointout', () => {
      this.pass.alpha = 1.0;
    });

    this.post =  Shape({
      width: 200,
      height: 50
    });
    this.post.backgroundColor = 'red';
    this.post.addChildTo(this);
    this.post.setPosition(this.gridX.center(5), this.gridY.center(6.8));
    this.post.setInteractive(false);
    this.post.onpointstart = () => {
          socket.emit('postTrumps', player.ID, postTrumps);
          socket.emit('changeTurn', player.ID, roomName);
          this.clearPlayerTrumps();
          this.createPlayerTrumps(this);
    };
    this.post.on('pointover', () => {
      this.post.alpha = 0.5;
    });
    this.post.on('pointout', () => {
      this.post.alpha = 1.0;
    });

    this.turnFlag = Shape({
      width: 30,
      height: 30
    });

    this.opponent =  Shape({
      width: 400,
      height: 75
    });
    this.opponent.backgroundColor = 'white';
    this.opponent.addChildTo(this);
    this.opponent.setPosition(this.gridX.center(5), this.gridY.center(-7.0));

    this.opponent2 =  Shape({
      width: 400,
      height: 75
    });
    this.opponent2.backgroundColor = 'white';
    this.opponent2.addChildTo(this);
    this.opponent2.setPosition(this.gridX.center(0), this.gridY.center(-7.0));

    this.opponent3 =  Shape({
      width: 400,
      height: 75
    });
    this.opponent3.backgroundColor = 'white';
    this.opponent3.addChildTo(this);
    this.opponent3.setPosition(this.gridX.center(-5), this.gridY.center(-7.0));

    //this.createLabel(this, 'idText', 'ID:', 'white', fontSize, 10,10);
    //this.createLabel(this, 'turnText', 'TURN:', 'white', fontSize, 10, 100);
    this.createLabel(this, 'postText', 'POST', 'white', 60, 1085, 705);
    this.createLabel(this, 'passText', 'PASS', 'white', 60, 185, 705);

   /*
    * 以下ゲームのsocket
    */

    //初期socket
    setTimeout(() => {
      socket.emit('joinPlayer', window.prompt("なまえをにゅうりょくしてね！", ""));
      //socket.emit('requestTrump');
    }, 100);

    socket.on('connection_test_from_server', (txt) => {
      console.log(txt);
    });

    socket.on('roomResponse', (_roomName) => {
      roomName = _roomName;
    });

    socket.on('joinResponse', (_player) => {
      player = _player;
      //this.createLabel(this, 'player_id', player.ID, 'white', fontSize, 100, 10);
      if(player.ID % 4 === 0) {
        this.turnFlag.show();
        this.pass.setInteractive(true);
        this.post.setInteractive(true);
      }
      else {
        this.pass.hide();
        this.post.hide();
      }
    });

    socket.on('joinOpponent', (_players) => {
      players = _players;
      players = players.filter((val) => {
        return val.ID !== player.ID; 
      })
      this.viewOpponentLabel(this);
      //console.log(players);
    });

    socket.on('getTrump', (_trumps) => {
      this.clientPoker = new ClientNekoCareerPoker(_trumps);
      trumps = this.clientPoker.rawTrumps;
      this.createPlayerTrumps(this);
    });

    socket.on('turnResponse', (nextPlayerId) => {
      if(player.ID === nextPlayerId) {
        this.turnFlag.show();
        this.pass.show();
        this.pass.setInteractive(true);
        this.post.show();
        this.post.setInteractive(true);
      }
      else {
        this.turnFlag.hide();
        this.pass.hide();
        this.pass.setInteractive(false);
        this.post.hide();
        this.post.setInteractive(false);
      }
      //console.log(nextPlayerId);
    });

    socket.on('stageTrumps', (_stageTrumps) => {
      this.clearStageTrumps(this);
      stageTrumps = _stageTrumps;
      this.createStageTrumps(this);
      //console.log(stageTrumps);
    });

    socket.on('changeOpponentLabel', (_opponents) => {
      players = _opponents.filter((val) => val.ID !== player.ID);
      this.clearOpponentLabel(this);
      this.viewOpponentLabel(this);
    });

  },
  // 毎フレーム更新処理
  update: function() {
  },
  createLabel: (self ,_name, _text, _color, _fontSize, _x, _y) => {
    labels[_name] = Label({text: _text, fill: _color, fontSize: _fontSize, x: _x, y: _y}).addChildTo(self).origin.set(0, 0);
  },
  createOpponentLabel: (self ,_name, _text, _color, _fontSize, _x, _y) => {
    self.opponentLabels.push(Label({text: _text, fill: _color, fontSize: _fontSize, x: _x, y: _y}).addChildTo(self));
  },
  createPlayerTrumps: (self) => {
    for(let i = 0; i < trumps.length; i++){
      let trumpMark = trumps[i][0];
      let trumpNum = trumps[i][1];
      let trumpFlag = trumps[i][2];
      let trump = trumpMark + trumpNum;
      
      let trumpSprite = Sprite(trump).addChildTo(self);
      trumpSprite.x = self.gridX.span(i * 1.05 + 1.05);
      trumpSprite.y = self.gridY.center(3.0);
      trumpSprite.setScale(0.2);
      trumpSprite.name = trump;
      trumpSprite.clickFlag = false;

      trumpSprites.push(trumpSprite);
      trumpSprite.setInteractive(true);
      trumpSprite.onpointstart = function() {
        if(!trumpSprite.clickFlag) {
          let postTrump = new Array();
          trumpSprite.y = self.gridY.center(2.5);
          trumpSprite.clickFlag = true
          postTrump.push(trump, trumpFlag);
          postTrumps.push(postTrump);
        }else {
          let deleteTrump = new Array();
          deleteTrump.push(trump, trumpFlag);
          trumpSprite.y = self.gridY.center(3.0);
          trumpSprite.clickFlag = false
          postTrumps = postTrumps.filter((val) => {
            console.log(val);
            console.log(deleteTrump);
            return JSON.stringify(val) != JSON.stringify(deleteTrump);
          });
        }
        console.log(postTrumps);
      };
      trumpSprite.on('pointover', () => {
        trumpSprite.alpha = 0.8;
      });
      trumpSprite.on('pointout', () => {
        trumpSprite.alpha = 1.0;
      });
      //console.log(trump); 
    }
    console.log(postTrumps);
  },
  clearPlayerTrumps: () => {
    let clearTrumps = new Array();
    for(let i = 0; i < postTrumps.length; i++) {
      let clearTrump = new Array();
      let trumpMark = postTrumps[i][0].substr(0, 1);
      let trumpNum = Number(postTrumps[i][0].substr(1));
      let trumpFlag = postTrumps[i][1];

      clearTrump.push(trumpMark);
      clearTrump.push(trumpNum);
      clearTrump.push(trumpFlag);
      clearTrumps.push(clearTrump);
      console.log(clearTrumps);
      console.log(trumps);
    }

    for(let i = 0; i < clearTrumps.length; i++) {
      trumps = trumps.filter((val) => {
        console.log(JSON.stringify(val) == JSON.stringify(clearTrumps[i]));
        return JSON.stringify(val) !== JSON.stringify(clearTrumps[i]);
      });
    }
    
    for(let i = 0; i < trumpSprites.length; i++) {
      trumpSprites[i].remove();
    }

    trumpSprites = new Array();
    postTrumps = new Array();
  },
  createStageTrumps: (self) => {
    for(let i = 0; i < stageTrumps.length; i++) {
      let trump = stageTrumps[i];
      let trumpSprite = Sprite(trump).addChildTo(self);
      trumpSprite.x = self.gridX.span(i * 1.05 + 5);
      trumpSprite.y = self.gridY.center(-2.5);
      trumpSprite.setScale(0.175);
      stageTrumpSprites.push(trumpSprite);
    }
  },
  clearStageTrumps: (self) => {
    for(let i = 0; i < stageTrumpSprites.length; i++) {
      stageTrumpSprites[i].remove();
    }
    stageTrumpSprites = new Array();
  },
  viewOpponentLabel: (self) => {
    for(let i = 0; i < players.length; i++) {
      let name = players[i].name + '(' + players[i].cardRemain +')';
      self.createOpponentLabel(self, players[i].ID, name, 'black', 30, 450 * i + 250, 50);
    }
  },
  clearOpponentLabel: (self) => {
    for(let i = 0; i < self.opponentLabels.length; i++) {
      self.opponentLabels[i].remove();
    }
  }
});

phina.main(function() {
  // アプリケーションを生成
  var app = GameApp({
    // MainScene から開始
    startLabel: 'main',
    // アセット読み込み
    assets: ASSETS,
    // 表示先のcanvasを指定
    query: '#mycanvas',
    // 画面をフィットさせない
    fit: false,
    width: 1440,
    height: 810,
  });
  // fps表示
  //app.enableStats();
  // 実行
  app.run();
});
</script>
<style>
html {
    height: 100%;
    
}

body {
    height: 100%;
    margin: 0;
    background-color: #fff;
}

header {
  height: 1%;
  width: 100%;
  padding: 15px 0;
  background-color: #337079;
  color: white;
}
header .headline{
    line-height: 0px;
    float: left;
    font-size: 20px;
    margin-left: 10px;
}
.nav-list {
    line-height: 5px;
    float: left;
    margin-left: 30px;
    list-style: none;
}
.nav-list-item {
  list-style: none;
  display: inline-block;
  margin: 0 20px;
}

.container {
  display: flex;
  flex-wrap: wrap;
}

#mycanvas {
  margin: 0 auto;
  width: 60%;
  height: 70%;
  display: inline-block;
  margin-left: auto;
  margin-right: auto;
  margin-top: 5%;
}

.text-area {
  display: inline-block;
  width: 25%;
  height: 90vh;
  border: solid #ff00ff;
  background-color: #fff;
}

.chat-area {
  width: auto;
  height: 44.5vh;
  border: solid green;
  position: relative;
  overflow:scroll;
  overflow-x: hidden;
}

.chat-container {
  width: 100%;
}

.chat-input {
  width: 70%;
}
.chat-button {
  width: 20%;
}

.info-area {
  width: auto;
  height: 42.0vh;
  border: solid blue;
}

.gameArea {
  display: inline-block;
  width: 74%;
}
.opponent-label-1 {
  position: relative;
  top: 10%;
  left: 10%;
  width: 30%;
  height: 30%;
  background-color: black;
  border: solid blue;
}

.opponent-label-2 {
  position: relative;
  top: 17%;
  left: 10%;
  width: 30%;
  background-color: black;
  border: solid blue;
}

.opponent-label-3 {
  position: relative;
  top: 17%;
  left: 10%;
  width: 30%;
  background-color: black;
  border: solid blue;
}
</style>